version: "3.9"
services:
  mssql:
    image: mcr.microsoft.com/mssql/server:2019-latest
    container_name: mssql-local
    restart: unless-stopped
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_PID: Developer
      SA_PASSWORD: "${MSSQL_SA_PASSWORD:-Nexylo!Local123}"
    ports:
      - "1433:1433"
    volumes:
      - mssql_data:/var/opt/mssql
    networks:
      - localnet

  redis:
    image: redis:6
    container_name: redis-local
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - localnet

  minio:
    image: minio/minio:RELEASE.2024-05-10T01-41-38Z
    container_name: minio-local
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: "${MINIO_ACCESS_KEY:-minioadmin}"
      MINIO_ROOT_PASSWORD: "${MINIO_SECRET_KEY:-minioadmin}"
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - localnet

  n8n:
    image: n8nio/n8n:1.61.4
    container_name: n8n-local
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      GENERIC_TIMEZONE: "${TIMEZONE:-UTC}"
      N8N_DIAGNOSTICS_ENABLED: "false"
      N8N_ENCRYPTION_KEY: "${N8N_ENCRYPTION_KEY:-local_n8n_key}"
      EXECUTIONS_PROCESS: main
      EXECUTIONS_DATA_SAVE_ON_SUCCESS: "true"
      EXECUTIONS_DATA_SAVE_ON_ERROR: "all"
      N8N_SECURE_COOKIE: "false"
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - localnet
    depends_on:
      - redis

  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: mailhog-local
    restart: unless-stopped
    ports:
      - "8025:8025"
    networks:
      - localnet

  backend:
    build:
      context: ../
      dockerfile: packages/backend/Dockerfile
    container_name: backend-local
    restart: unless-stopped
    env_file:
      - ../.env
    ports:
      - "4000:4000"
    depends_on:
      - mssql
      - redis
      - minio
    volumes:
      - ../packages/backend:/usr/src/app
    networks:
      - localnet

networks:
  localnet:
    driver: bridge

volumes:
  mssql_data:
  redis_data:
  minio_data:
  n8n_data:
